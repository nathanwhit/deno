/* esm.sh - esbuild bundle(@smithy/util-endpoints@1.1.1) denonext production */
var Q=new RegExp("^(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}$"),O=e=>Q.test(e)||e.startsWith("[")&&e.endsWith("]");var Y=new RegExp("^(?!.*-$)(?!-)[a-zA-Z0-9-]{1,63}$"),b=(e,r=!1)=>{if(!r)return Y.test(e);let t=e.split(".");for(let o of t)if(!b(o))return!1;return!0};var v={};var d="endpoints";function u(e){return typeof e!="object"||e==null?e:"ref"in e?`$${u(e.ref)}`:"fn"in e?`${e.fn}(${(e.argv||[]).map(u).join(", ")})`:JSON.stringify(e,null,2)}var s=class extends Error{constructor(r){super(r),this.name="EndpointError"}};var S=(e,r)=>e===r;var T=e=>{let r=e.split("."),t=[];for(let o of r){let i=o.indexOf("[");if(i!==-1){if(o.indexOf("]")!==o.length-1)throw new s(`Path: '${e}' does not end with ']'`);let n=o.slice(i+1,-1);if(Number.isNaN(parseInt(n)))throw new s(`Invalid array index: '${n}' in path: '${e}'`);i!==0&&t.push(o.slice(0,i)),t.push(n)}else t.push(o)}return t};var x=(e,r)=>T(r).reduce((t,o)=>{if(typeof t!="object")throw new s(`Index '${o}' in '${r}' not found in '${JSON.stringify(e)}'`);return Array.isArray(t)?t[parseInt(o)]:t[o]},e);var C=e=>e!=null;var q=e=>!e;import{EndpointURLScheme as U}from"/v135/@smithy/types@2.9.1/denonext/types.mjs";var y={[U.HTTP]:80,[U.HTTPS]:443},D=e=>{let r=(()=>{try{if(e instanceof URL)return e;if(typeof e=="object"&&"hostname"in e){let{hostname:P,port:I,protocol:G="",path:X="",query:M={}}=e,A=new URL(`${G}//${P}${I?`:${I}`:""}${X}`);return A.search=Object.entries(M).map(([Z,K])=>`${Z}=${K}`).join("&"),A}return new URL(e)}catch{return null}})();if(!r)return console.error(`Unable to parse ${JSON.stringify(e)} as a whatwg URL.`),null;let t=r.href,{host:o,hostname:i,pathname:n,protocol:f,search:a}=r;if(a)return null;let p=f.slice(0,-1);if(!Object.values(U).includes(p))return null;let c=O(i),m=t.includes(`${o}:${y[p]}`)||typeof e=="string"&&e.includes(`${o}:${y[p]}`),w=`${o}${m?`:${y[p]}`:""}`;return{scheme:p,authority:w,path:n,normalizedPath:n.endsWith("/")?n:`${n}/`,isIp:c}};var F=(e,r)=>e===r;var H=(e,r,t,o)=>r>=t||e.length<t?null:o?e.substring(e.length-t,e.length-r):e.substring(r,t);var N=e=>encodeURIComponent(e).replace(/[!*'()]/g,r=>`%${r.charCodeAt(0).toString(16).toUpperCase()}`);var j={booleanEquals:S,getAttr:x,isSet:C,isValidHostLabel:b,not:q,parseURL:D,stringEquals:F,substring:H,uriEncode:N};var E=(e,r)=>{let t=[],o={...r.endpointParams,...r.referenceRecord},i=0;for(;i<e.length;){let n=e.indexOf("{",i);if(n===-1){t.push(e.slice(i));break}t.push(e.slice(i,n));let f=e.indexOf("}",n);if(f===-1){t.push(e.slice(n));break}e[n+1]==="{"&&e[f+1]==="}"&&(t.push(e.slice(n+1,f)),i=f+2);let a=e.substring(n+1,f);if(a.includes("#")){let[p,c]=a.split("#");t.push(x(o[p],c))}else t.push(o[a]);i=f+1}return t.join("")};var V=({ref:e},r)=>({...r.endpointParams,...r.referenceRecord})[e];var l=(e,r,t)=>{if(typeof e=="string")return E(e,t);if(e.fn)return h(e,t);if(e.ref)return V(e,t);throw new s(`'${r}': ${String(e)} is not a string, function or reference.`)};var h=({fn:e,argv:r},t)=>{let o=r.map(n=>["boolean","number"].includes(typeof n)?n:l(n,"arg",t)),i=e.split(".");return i[0]in v&&i[1]!=null?v[i[0]][i[1]](...o):j[e](...o)};var _=({assign:e,...r},t)=>{if(e&&e in t.referenceRecord)throw new s(`'${e}' is already defined in Reference Record.`);let o=h(r,t);return t.logger?.debug?.(d,`evaluateCondition: ${u(r)} = ${u(o)}`),{result:o===""?!0:!!o,...e!=null&&{toAssign:{name:e,value:o}}}};var g=(e=[],r)=>{let t={};for(let o of e){let{result:i,toAssign:n}=_(o,{...r,referenceRecord:{...r.referenceRecord,...t}});if(!i)return{result:i};n&&(t[n.name]=n.value,r.logger?.debug?.(d,`assign: ${n.name} := ${u(n.value)}`))}return{result:!0,referenceRecord:t}};var k=(e,r)=>Object.entries(e).reduce((t,[o,i])=>({...t,[o]:i.map(n=>{let f=l(n,"Header value entry",r);if(typeof f!="string")throw new s(`Header '${o}' value '${f}' is not a string`);return f})}),{});var L=(e,r)=>{if(Array.isArray(e))return e.map(t=>L(t,r));switch(typeof e){case"string":return E(e,r);case"object":if(e===null)throw new s(`Unexpected endpoint property: ${e}`);return R(e,r);case"boolean":return e;default:throw new s(`Unexpected endpoint property type: ${typeof e}`)}};var R=(e,r)=>Object.entries(e).reduce((t,[o,i])=>({...t,[o]:L(i,r)}),{});var B=(e,r)=>{let t=l(e,"Endpoint URL",r);if(typeof t=="string")try{return new URL(t)}catch(o){throw console.error(`Failed to construct URL with ${t}`,o),o}throw new s(`Endpoint URL must be a string, got ${typeof t}`)};var W=(e,r)=>{let{conditions:t,endpoint:o}=e,{result:i,referenceRecord:n}=g(t,r);if(!i)return;let f={...r,referenceRecord:{...r.referenceRecord,...n}},{url:a,properties:p,headers:c}=o;return r.logger?.debug?.(d,`Resolving endpoint from template: ${u(o)}`),{...c!=null&&{headers:k(c,f)},...p!=null&&{properties:R(p,f)},url:B(a,f)}};var J=(e,r)=>{let{conditions:t,error:o}=e,{result:i,referenceRecord:n}=g(t,r);if(i)throw new s(l(o,"Error",{...r,referenceRecord:{...r.referenceRecord,...n}}))};var z=(e,r)=>{let{conditions:t,rules:o}=e,{result:i,referenceRecord:n}=g(t,r);if(i)return $(o,{...r,referenceRecord:{...r.referenceRecord,...n}})};var $=(e,r)=>{for(let t of e)if(t.type==="endpoint"){let o=W(t,r);if(o)return o}else if(t.type==="error")J(t,r);else if(t.type==="tree"){let o=z(t,r);if(o)return o}else throw new s(`Unknown endpoint rule: ${t}`);throw new s("Rules evaluation failed")};var Wr=(e,r)=>{let{endpointParams:t,logger:o}=r,{parameters:i,rules:n}=e;r.logger?.debug?.(`${d} Initial EndpointParams: ${u(t)}`);let f=Object.entries(i).filter(([,c])=>c.default!=null).map(([c,m])=>[c,m.default]);if(f.length>0)for(let[c,m]of f)t[c]=t[c]??m;let a=Object.entries(i).filter(([,c])=>c.required).map(([c])=>c);for(let c of a)if(t[c]==null)throw new s(`Missing required parameter: '${c}'`);let p=$(n,{endpointParams:t,logger:o,referenceRecord:{}});if(r.endpointParams?.Endpoint)try{let c=new URL(r.endpointParams.Endpoint),{protocol:m,port:w}=c;p.url.protocol=m,p.url.port=w}catch{}return r.logger?.debug?.(`${d} Resolved endpoint: ${u(p)}`),p};export{s as EndpointError,v as customEndpointFunctions,O as isIpAddress,b as isValidHostLabel,Wr as resolveEndpoint};
//# sourceMappingURL=util-endpoints.mjs.map