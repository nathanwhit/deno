/* esm.sh - esbuild bundle(@smithy/middleware-stack@2.1.1) denonext production */
var h=(l,a)=>{let p=[];if(l&&p.push(l),a)for(let c of a)p.push(c);return p},m=(l,a)=>`${l||"anonymous"}${a&&a.length>0?` (a.k.a. ${a.join(",")})`:""}`,M=()=>{let l=[],a=[],p=!1,c=new Set,y=e=>e.sort((i,r)=>R[r.step]-R[i.step]||O[r.priority||"normal"]-O[i.priority||"normal"]),z=e=>{let i=!1,r=n=>{let d=h(n.name,n.aliases);if(d.includes(e)){i=!0;for(let t of d)c.delete(t);return!1}return!0};return l=l.filter(r),a=a.filter(r),i},x=e=>{let i=!1,r=n=>{if(n.middleware===e){i=!0;for(let d of h(n.name,n.aliases))c.delete(d);return!1}return!0};return l=l.filter(r),a=a.filter(r),i},$=e=>(l.forEach(i=>{e.add(i.middleware,{...i})}),a.forEach(i=>{e.addRelativeTo(i.middleware,{...i})}),e.identifyOnResolve?.(v.identifyOnResolve()),e),E=e=>{let i=[];return e.before.forEach(r=>{r.before.length===0&&r.after.length===0?i.push(r):i.push(...E(r))}),i.push(e),e.after.reverse().forEach(r=>{r.before.length===0&&r.after.length===0?i.push(r):i.push(...E(r))}),i},g=(e=!1)=>{let i=[],r=[],n={};return l.forEach(t=>{let s={...t,before:[],after:[]};for(let o of h(s.name,s.aliases))n[o]=s;i.push(s)}),a.forEach(t=>{let s={...t,before:[],after:[]};for(let o of h(s.name,s.aliases))n[o]=s;r.push(s)}),r.forEach(t=>{if(t.toMiddleware){let s=n[t.toMiddleware];if(s===void 0){if(e)return;throw new Error(`${t.toMiddleware} is not found when adding ${m(t.name,t.aliases)} middleware ${t.relation} ${t.toMiddleware}`)}t.relation==="after"&&s.after.push(t),t.relation==="before"&&s.before.push(t)}}),y(i).map(E).reduce((t,s)=>(t.push(...s),t),[])},v={add:(e,i={})=>{let{name:r,override:n,aliases:d}=i,t={step:"initialize",priority:"normal",middleware:e,...i},s=h(r,d);if(s.length>0){if(s.some(o=>c.has(o))){if(!n)throw new Error(`Duplicate middleware name '${m(r,d)}'`);for(let o of s){let u=l.findIndex(w=>w.name===o||w.aliases?.some(b=>b===o));if(u===-1)continue;let f=l[u];if(f.step!==t.step||t.priority!==f.priority)throw new Error(`"${m(f.name,f.aliases)}" middleware with ${f.priority} priority in ${f.step} step cannot be overridden by "${m(r,d)}" middleware with ${t.priority} priority in ${t.step} step.`);l.splice(u,1)}}for(let o of s)c.add(o)}l.push(t)},addRelativeTo:(e,i)=>{let{name:r,override:n,aliases:d}=i,t={middleware:e,...i},s=h(r,d);if(s.length>0){if(s.some(o=>c.has(o))){if(!n)throw new Error(`Duplicate middleware name '${m(r,d)}'`);for(let o of s){let u=a.findIndex(w=>w.name===o||w.aliases?.some(b=>b===o));if(u===-1)continue;let f=a[u];if(f.toMiddleware!==t.toMiddleware||f.relation!==t.relation)throw new Error(`"${m(f.name,f.aliases)}" middleware ${f.relation} "${f.toMiddleware}" middleware cannot be overridden by "${m(r,d)}" middleware ${t.relation} "${t.toMiddleware}" middleware.`);a.splice(u,1)}}for(let o of s)c.add(o)}a.push(t)},clone:()=>$(M()),use:e=>{e.applyToStack(v)},remove:e=>typeof e=="string"?z(e):x(e),removeByTag:e=>{let i=!1,r=n=>{let{tags:d,name:t,aliases:s}=n;if(d&&d.includes(e)){let o=h(t,s);for(let u of o)c.delete(u);return i=!0,!1}return!0};return l=l.filter(r),a=a.filter(r),i},concat:e=>{let i=$(M());return i.use(e),i.identifyOnResolve(p||i.identifyOnResolve()||(e.identifyOnResolve?.()??!1)),i},applyToStack:$,identify:()=>g(!0).map(e=>{let i=e.step??e.relation+" "+e.toMiddleware;return m(e.name,e.aliases)+" - "+i}),identifyOnResolve(e){return typeof e=="boolean"&&(p=e),p},resolve:(e,i)=>{for(let r of g().map(n=>n.middleware).reverse())e=r(e,i);return p&&console.log(v.identify()),e}};return v},R={initialize:5,serialize:4,build:3,finalizeRequest:2,deserialize:1},O={high:3,normal:2,low:1};export{M as constructStack};
//# sourceMappingURL=middleware-stack.mjs.map