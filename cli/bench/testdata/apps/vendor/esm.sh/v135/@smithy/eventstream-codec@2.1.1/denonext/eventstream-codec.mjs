/* esm.sh - esbuild bundle(@smithy/eventstream-codec@2.1.1) denonext production */
import{Crc32 as q}from"/v135/@aws-crypto/crc32@3.0.0/denonext/crc32.mjs";import{fromHex as S,toHex as y}from"/v135/@smithy/util-hex-encoding@2.1.1/denonext/util-hex-encoding.mjs";import{toHex as M}from"/v135/@smithy/util-hex-encoding@2.1.1/denonext/util-hex-encoding.mjs";var l=class s{constructor(t){if(this.bytes=t,t.byteLength!==8)throw new Error("Int64 buffers must be exactly 8 bytes")}static fromNumber(t){if(t>9223372036854776e3||t<-9223372036854776e3)throw new Error(`${t} is too large (or, if negative, too small) to represent as an Int64`);let e=new Uint8Array(8);for(let r=7,o=Math.abs(Math.round(t));r>-1&&o>0;r--,o/=256)e[r]=o;return t<0&&w(e),new s(e)}valueOf(){let t=this.bytes.slice(0),e=t[0]&128;return e&&w(t),parseInt(M(t),16)*(e?-1:1)}toString(){return String(this.valueOf())}};function w(s){for(let t=0;t<8;t++)s[t]^=255;for(let t=7;t>-1&&(s[t]++,s[t]===0);t--);}var m=class{constructor(t,e){this.toUtf8=t,this.fromUtf8=e}format(t){let e=[];for(let n of Object.keys(t)){let a=this.fromUtf8(n);e.push(Uint8Array.from([a.byteLength]),a,this.formatHeaderValue(t[n]))}let r=new Uint8Array(e.reduce((n,a)=>n+a.byteLength,0)),o=0;for(let n of e)r.set(n,o),o+=n.byteLength;return r}formatHeaderValue(t){switch(t.type){case"boolean":return Uint8Array.from([t.value?0:1]);case"byte":return Uint8Array.from([2,t.value]);case"short":let e=new DataView(new ArrayBuffer(3));return e.setUint8(0,3),e.setInt16(1,t.value,!1),new Uint8Array(e.buffer);case"integer":let r=new DataView(new ArrayBuffer(5));return r.setUint8(0,4),r.setInt32(1,t.value,!1),new Uint8Array(r.buffer);case"long":let o=new Uint8Array(9);return o[0]=5,o.set(t.value.bytes,1),o;case"binary":let n=new DataView(new ArrayBuffer(3+t.value.byteLength));n.setUint8(0,6),n.setUint16(1,t.value.byteLength,!1);let a=new Uint8Array(n.buffer);return a.set(t.value,3),a;case"string":let c=this.fromUtf8(t.value),i=new DataView(new ArrayBuffer(3+c.byteLength));i.setUint8(0,7),i.setUint16(1,c.byteLength,!1);let p=new Uint8Array(i.buffer);return p.set(c,3),p;case"timestamp":let g=new Uint8Array(9);return g[0]=8,g.set(l.fromNumber(t.value.valueOf()).bytes,1),g;case"uuid":if(!F.test(t.value))throw new Error(`Invalid UUID received: ${t.value}`);let h=new Uint8Array(17);return h[0]=9,h.set(S(t.value.replace(/\-/g,"")),1),h}}parse(t){let e={},r=0;for(;r<t.byteLength;){let o=t.getUint8(r++),n=this.toUtf8(new Uint8Array(t.buffer,t.byteOffset+r,o));switch(r+=o,t.getUint8(r++)){case 0:e[n]={type:d,value:!0};break;case 1:e[n]={type:d,value:!1};break;case 2:e[n]={type:G,value:t.getInt8(r++)};break;case 3:e[n]={type:N,value:t.getInt16(r,!1)},r+=2;break;case 4:e[n]={type:$,value:t.getInt32(r,!1)},r+=4;break;case 5:e[n]={type:A,value:new l(new Uint8Array(t.buffer,t.byteOffset+r,8))},r+=8;break;case 6:let a=t.getUint16(r,!1);r+=2,e[n]={type:C,value:new Uint8Array(t.buffer,t.byteOffset+r,a)},r+=a;break;case 7:let c=t.getUint16(r,!1);r+=2,e[n]={type:T,value:this.toUtf8(new Uint8Array(t.buffer,t.byteOffset+r,c))},r+=c;break;case 8:e[n]={type:L,value:new Date(new l(new Uint8Array(t.buffer,t.byteOffset+r,8)).valueOf())},r+=8;break;case 9:let i=new Uint8Array(t.buffer,t.byteOffset+r,16);r+=16,e[n]={type:z,value:`${y(i.subarray(0,4))}-${y(i.subarray(4,6))}-${y(i.subarray(6,8))}-${y(i.subarray(8,10))}-${y(i.subarray(10))}`};break;default:throw new Error("Unrecognized header type tag")}}return e}},b;(function(s){s[s.boolTrue=0]="boolTrue",s[s.boolFalse=1]="boolFalse",s[s.byte=2]="byte",s[s.short=3]="short",s[s.integer=4]="integer",s[s.long=5]="long",s[s.byteArray=6]="byteArray",s[s.string=7]="string",s[s.timestamp=8]="timestamp",s[s.uuid=9]="uuid"})(b||(b={}));var d="boolean",G="byte",N="short",$="integer",A="long",C="binary",T="string",L="timestamp",z="uuid",F=/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/;import{Crc32 as j}from"/v135/@aws-crypto/crc32@3.0.0/denonext/crc32.mjs";var U=4,f=U*2,u=4,K=f+u*2;function v({byteLength:s,byteOffset:t,buffer:e}){if(s<K)throw new Error("Provided message too short to accommodate event stream message overhead");let r=new DataView(e,t,s),o=r.getUint32(0,!1);if(s!==o)throw new Error("Reported message length does not match received message length");let n=r.getUint32(U,!1),a=r.getUint32(f,!1),c=r.getUint32(s-u,!1),i=new j().update(new Uint8Array(e,t,f));if(a!==i.digest())throw new Error(`The prelude checksum specified in the message (${a}) does not match the calculated CRC32 checksum (${i.digest()})`);if(i.update(new Uint8Array(e,t+f,s-(f+u))),c!==i.digest())throw new Error(`The message checksum (${i.digest()}) did not match the expected value of ${c}`);return{headers:new DataView(e,t+f+u,n),body:new Uint8Array(e,t+f+u+n,o-n-(f+u+u))}}var I=class{constructor(t,e){this.headerMarshaller=new m(t,e),this.messageBuffer=[],this.isEndOfStream=!1}feed(t){this.messageBuffer.push(this.decode(t))}endOfStream(){this.isEndOfStream=!0}getMessage(){let t=this.messageBuffer.pop(),e=this.isEndOfStream;return{getMessage(){return t},isEndOfStream(){return e}}}getAvailableMessages(){let t=this.messageBuffer;this.messageBuffer=[];let e=this.isEndOfStream;return{getMessages(){return t},isEndOfStream(){return e}}}encode({headers:t,body:e}){let r=this.headerMarshaller.format(t),o=r.byteLength+e.byteLength+16,n=new Uint8Array(o),a=new DataView(n.buffer,n.byteOffset,n.byteLength),c=new q;return a.setUint32(0,o,!1),a.setUint32(4,r.byteLength,!1),a.setUint32(8,c.update(n.subarray(0,8)).digest(),!1),n.set(r,12),n.set(e,r.byteLength+12),a.setUint32(o-4,c.update(n.subarray(8,o-4)).digest(),!1),n}decode(t){let{headers:e,body:r}=v(t);return{headers:this.headerMarshaller.parse(e),body:r}}formatHeaders(t){return this.headerMarshaller.format(t)}};var x=class{constructor(t){this.options=t}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(let t of this.options.inputStream)yield this.options.decoder.decode(t)}};var k=class{constructor(t){this.options=t}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(let t of this.options.messageStream)yield this.options.encoder.encode(t);this.options.includeEndFrame&&(yield new Uint8Array(0))}};var B=class{constructor(t){this.options=t}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(let t of this.options.messageStream){let e=await this.options.deserializer(t);e!==void 0&&(yield e)}}};var O=class{constructor(t){this.options=t}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(let t of this.options.inputStream)yield this.options.serializer(t)}};export{I as EventStreamCodec,m as HeaderMarshaller,l as Int64,x as MessageDecoderStream,k as MessageEncoderStream,B as SmithyMessageDecoderStream,O as SmithyMessageEncoderStream};
//# sourceMappingURL=eventstream-codec.mjs.map